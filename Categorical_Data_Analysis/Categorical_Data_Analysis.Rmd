---
title: "Project 1 - Categorical Data Analysis"
author: "Taylor Longmire"
date: "3/26/2021"
output: 
  pdf_document: 
    fig_height: 4
header-includes:
    - \usepackage{caption}
---

\captionsetup[table]{labelformat=empty}

```{r data, echo = FALSE, warning = FALSE, message = FALSE}
source("http://www.openintro.org/stat/data/cdc.R")
cdc$wtdesire<- cdc$weight -cdc$wtdesire
library(ggplot2)
library(tidyverse)
library(cvms)
library(broom) 
library(cowplot)
library(nnet)
library(reshape2)
```

## Abstract/Executive Summary

When discussing an individual's health, or the health of a particular group of individuals, there are particular features that must be taken into consideration. Some such features include an individual's age, whether or not an individual smokes, whether or not an individual exercises, whether or not an individual had health coverage, and how far an individual is from their desired weight. In this report, we will use these features to examine the relationship between an individual's age and whether or not they have health coverage and whether or not an individual smokes at least 100 cigarettes in their lifetime. For this question, we will let whether or not an individual smokes at least 100 cigarettes in their lifetime be what we are attempting to predict. In this report we will also examine the relationship between smoking, exercise, desired weight change, having health coverage, and age on an individual's overall evaluation of their health. For this question, we will let how a person evaluates heir health be what we are attempting to predict. The data for this study was collected through 350,000 adult telephone interviews in the United States by the Behavioral Risk Factor Surveillance System (BRFSS), and we applied logistic and multinomial modeling, as well as some variable testing, to describe the relationships of interest as well as determine the usefulness of our models. The data is first explored for each research question, and the steps for creating and testing each model is detailed in the report. Based on our results, as age increases from around age 19 to 65, individuals are more likely to have smoked at least 100 cigarettes in their lifetime, as age increases from about age 65 onward, individuals are less likely to have smoked at least 100 cigarettes in their lifetime, and individuals are less likely to have smoked 100 cigarettes in their lifetime if they have health coverage. We also found that individuals who do not smoke, do exercise, have a health plan, and are already close to their desired weight generally evaluate their health as good or very good. We will discuss these findings  and how we came to those conclusions in the report.

## Section 1: EDA: Research Question 1

The first question we would like to explore is the relationship between age and having health coverage and whether or not a person smokes at least 100 cigarettes in their lifetime. Before diving into this relationship, let us first examine the data and extract any information that may be helpful in constructing a useful model. 

The table below (Table 1.1) shows the counts for whether or not an individual has smoked 100 cigarettes in their lifetime, where 0 = no, and 1 = yes. With 10,559 individual who have not smoked more than 100 cigarettes in their life, and 9,441 individuals who have smoked more than 100 cigarettes in their life, this leaves us with 52.80% of our data in our largest category and 47.20% of our data in our smallest category. Because there is a noticeable difference between our two levels, and we see at least 10% of the data in our smallest category, we can confidently proceed with our analysis, as there is enough data in the different categories in the response variable to allow us to construct a useful model. 

```{r table1, echo = FALSE}
knitr::kable(table(cdc$smoke100), col.names=c("Smoked 100 Cigarettes", "Count"), 
             caption = "Table 1.1: Smoked 100 Cigarettes Counts")
```

```{r calc1, echo = FALSE, eval = FALSE}
(10559 / (10559+9441)) * 100
(9441 / (10559+9441)) * 100
```

Now that we are confident that there is enough data in each of the categories in our response variable, let's move on the exploring the relationship between $Y$ and our predictors. First, let us examine the relationship between whether or not an individual smokes 100 cigarettes in their lifetime and the individual's age. The empirical logit plot below (Figure 1.1) displays the relationship between an individual's age and the log odds of smoking 100 cigarettes in their lifetime. 

After examining the empirical logit plot for these variables, it is clear that the relationship between age and whether or not an individual smokes 100 cigarettes in their lifetime is not linear. Further, there appears to be about 2 changes in direction in the plot--with the log odds decreasing from around age 20 to 30, the log odds increasing from around age 30 to 65, and then the log odds decreasing again from around age 65 to 90. Thus, it may be useful to use a second-order polynomial for modeling this relationship. 

```{r function, echo = FALSE}
empLogitPlot <- function(x, y, nclass = floor(sqrt(length(x)))) {
  require(arm)
  require(ggplot2)
  
  logit <- function (x, eps = 0.05) log((eps + x)/(1 - x + eps))
  
  binned.df <- as.data.frame(binned.resids(x = x, y = y, nclass = nclass)[[1]])
  
  p <- qplot(x = xbar, y = logit(ybar), data = binned.df, se = FALSE) + 
    ylim(min(logit(binned.df$ybar)), max(logit(binned.df$ybar)))
  return(p)
}
```

```{r epirlogit-plot, echo = FALSE, message = FALSE, warning = FALSE}
empLogitPlot(x = cdc$age, y = cdc$smoke100) +
  labs(title = "Figure 1.1: Empirical Logit Plot for Age", x = "Age", 
       y = "Log Odds of Smoking 100 Cigarettes in Lifetime") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ x, size = 1, color = "darkorchid3")
```

To examine the usefulness of using a second-order polynomial to model this relationship, another empirical logit plot was constructed (Figure 1.2), which displays the same relationship with a second-order polynomial term added. After examining this plot, it appears that the model would be much stronger if a second-order polynomial transformation were used. 

```{r epirlogit-plot2, echo = FALSE, message = FALSE, warning = FALSE}
empLogitPlot(x = cdc$age, y = cdc$smoke100) +
labs(title = "Figure 1.2: Empirical Logit Plot for Age with Second-Order Polynomial", 
       x = "Age", y = "Log Odds of Smoking 100 Cigarettes in Lifetime") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ poly(x,2), size = 1, 
              color = "darkorchid3")
```

Now, let us explore the relationship between whether or not an individual smokes 100 cigarettes in their lifetime and our other explanatory variable, whether or not the individual has a health plan. To explore this relationship, a bar graph displaying the proportion of individuals who have and have not smoked 100 cigarettes in their lifetime, divided by whether or not they have a health plan, is created (Figure 1.3). Based on this graph, it appears that whether or not an individual smokes 100 cigarettes in their lifetime is relatively evenly divided both among individuals who do have a health plan, and among individual who do not have a health plan. However, there may be a slight relationship, as the proportion of individuals who smoke 100 cigarettes in their lifetime is slightly larger for individuals who do not have a health plan, and slightly smaller for individuals who do have a health plan. Thus, although the relationship is not strong, it may exist. 

```{r bar-plot, echo = FALSE}
ggplot(data = cdc, aes(x = factor(hlthplan),  group = factor(smoke100))) + 
    geom_bar(aes(y = ..prop.., fill = factor(smoke100)), stat = "count",
             position = position_dodge()) +
  scale_x_discrete(labels = c("No Plan", "Has Plan")) +
  scale_fill_manual(name = "Smoke 100 Cigarettes in Lifetime", 
                      labels = c("No", "Yes"),
                      values = c("plum3", "plum4")) +
labs(title = "Figure 1.3: Smokes 100 Cigarettes in Lifetime by Healthplan Status", 
       x = "Health Plan", 
       y = "Proportion") +
  theme_light()
```

## Section 2: Modeling: Research Question 1

Now that we have explored the relationship between our response variable and our explanatory variables, as well as confirmed that there is ample data to work with, we can begin to model this relationship. Since we have a binary response variable, whether or not an individual smoked 100 cigarettes in their lifetime, where $P(Y_i = 1) = \pi_i$, we can reasonable assume a Bernoulli distribution, $Y_i \sim Bernoulli(\pi_i)$, where $P(Y_i = 1) = \pi_i$ is the probability that an individual has smoked 100 cigarettes in their lifetime, and $P(Y_i = 0) = 1 - \pi_i$ is the probability that an individual has not smoked 100 cigarettes in their lifetime. 

Because we have a Bernoulli distribution, where the only parameter we need to estimate is $\pi_i$ for each row $i$ in the data set, we will select a logistic regression model for modeling our relationship. Recalling our second-order polynomial transformation, the model will be written as:

$$log \left( \frac{\pi_i}{1-\pi_i} \right) = \beta_0 + \beta_1Age_i + \beta_2Age_i^2  + \beta_3HealthPlan_i $$

```{r fit-model, echo = FALSE, include = FALSE}
model1 <- glm(smoke100 ~ age + I(age^2) + hlthplan, data = cdc, 
              family = "binomial")
coef(model1)
summary(model1)
```

After fitting the model above, we have our final model to be used to estimate our parameter $\pi_i$:

$$log \left( \frac{\hat{\pi_i}}{1-\hat{\pi_i}} \right) = -1.34453 + 0.05650Age_i - 0.00043Age_i^2 - 0.35803HealthPlan_i $$

Now that we have a fitted model for examining the relationship between our response variable and our explanatory variables, let us recall that the relationship between whether or not an individual smoked 100 cigarettes in their lifetime and whether or not they have a health plan appeared relatively weak in Figure 1.3. In order to better understand whether or not this variable should be considered when predicting whether or not an individual smoked 100 cigarettes in their lifetime, let us first conduct a hypothesis test. 

For our hypothesis test, the null hypothesis is that $\beta_3 = 0$, or that whether or not an individual has a health plan *is not* a significant predictor for whether or not someone smokes 100 cigarettes in their lifetime. The alternate hypothesis is that $\beta_3 \neq 0$, or that whether or not an individual has a health plan *is* a significant predictor for whether or not someone smokes 100 cigarettes in their lifetime

Because we are conducting this hypothesis test on a logistic regression model, we will be using a *z-test*, where our test statistic is:

$$z = \frac{\hat{\beta_3} - 0}{SE_{\hat{\beta_3}}} = \frac{-0.35803 - 0}{0.04405} = \frac{-0.35803}{0.04405} = -8.12781$$

Also, if the null hypothesis were true ($\beta_4 = 0$), the test statistic $z$ would follow a standard normal distribution ($z \sim N(0, 1)$).

After performing a two-tailed z-test, we get a p-value of $4.3712\times10^{-16}$ or 0.00000000000000043712%. The p-value is the probability that, if the null were true, we would see a test statistic as or more extreme as -8.12781 just by random chance. Thus, due to a p-value less than an alpha level of $\alpha = 0.05$, we reject the null hypothesis. Therefore, there is convincing evidence that whether or not an individual has a health plan is a significant predictor for whether or not someone smokes 100 cigarettes in their lifetime. 

```{r calc2, echo = FALSE, eval = FALSE}
-0.35803/0.04405
2*pnorm(-8.12781)
```

To confirm our result, let us also compare the model containing whether or not an individual has a health plan with a model that does not. To compare these models, we will examine the AIC. The AIC for the model containing whether or not an individual has a health plan as a predictor is $27,284.19$, while the AIC for the model not containing whether or not an individual has a health plan as a predictor is $27,348.43$. Thus, due to the model containing whether or not an individual has a health plan as a predictor having a lower AIC than the model not containing whether or not an individual has a health plan as a predictor, we agree with our hypothesis test that whether or not an individual has a health plan is a significant predictor in the model. Thus, we will continue forward with our current model. 

```{r compare-models, echo = FALSE, eval = FALSE}
model2 <- glm(smoke100 ~ age + I(age^2), data = cdc, family = "binomial")
AIC(model1)
AIC(model2)
```

Now that we have settled on a model, let us examine the usefulness of this model, as well as what the model is telling us. We will start by examining the percent drop in deviance of our model compared to the null model. The deviance of the null model is 27,663, while the deviance of our fitted model it 27,276. Thus, the percent drop in deviance can be found by:

$$\%dropDev = \frac{27,663 - 27,276}{27,663} = \frac{387}{27,663} \times 100 = 1.399\%$$
Although a 1.399% drop in deviance is not a huge percentage, it does show that there is a difference between the null model and our fitted model.

```{r ddp, echo = FALSE, eval = FALSE}
summary(model1)
27663-27276
(387/27663)*100
```

Let us now examine our model further by constructing 95% confidence intervals for our predictors of interest. To find out confidence intervals, we will use:

$$\hat{\beta_i} \pm z^*SE_{\hat{\beta_i}}$$

Because we are constructing a 95% confidence interval, our $z^*$ will be 1.96. Thus, to construct our confidence interval for $\hat{\beta_1} = Age$, we will write:

$$0.0565 \pm (1.96\times0.005) = (0.0467, 0.0663)$$

And to construct our confidence interval for $\hat{\beta_2} = Age^2$, we will write:

$$-0.0004 \pm (1.96\times0.00005) = (-0.000498, -0.000302)$$

Finally, to construct our confidence interval for $\hat{\beta_3} = HealthPlan$, we will write:

$$-0.358 \pm (1.96\times0.0441) = (-0.4444, -0.2716)$$

The table below (Table 2.1) displays all of the above 95% confidence intervals for our parameters of interest. This means that we are 95% confident that the log odds of an individual smoking 100 cigarettes in their lifetime increases by between 0.0467 and 0.0663 for every additional year in age, decreases by between 0.000498 and 0.000302 for every additional year in $age^2$, and decreases by between 0.4444 and 0.2716 for an individual who has a health plan.

```{r table-ci, echo = FALSE}
df <- data.frame(first_column = c("0.0467", "-0.000498", "-0.4444"),
                 second_column = c("0.0663", "-0.000302", "-0.2716"),
                 row.names = c("Age", "Age^2", "HealthPlan"))
knitr::kable(x = df, col.names = c("2.5%", "97.5%"), 
             caption = "Table 2.1: 95% Confidence Intervals")
```

```{r calc3, echo = FALSE, eval = FALSE}
0.0565-(1.96*0.005)
0.0565+(1.96*0.005)

-0.0004-(1.96*0.00005)
-0.0004+(1.96*0.00005)

-0.358-(1.96*0.0441)
-0.358+(1.96*0.0441)
```

Thus, based on the model created, we can respond to our research question of what is the relationship between age and having health coverage and whether or not a person smokes at least 100 cigarettes in their lifetime by stating that we expect the odds of a person smoking at least 100 cigarettes in their lifetime to increase by a multiplier of about 1.0581 for every additional year in age, to decrease by a multiplier of about 0.9996 for every additional year in $age^2$, and to decrease by a multiplier of about 0.6991 if an individual has a health plan. Thus, as age increases from around age 19 to 65, individuals are more likely to have smoked at least 100 cigarettes in their lifetime, as age increases from about age 65 onward, individuals are less likely to have smoked at least 100 cigarettes in their lifetime, and individuals are less likely to have smoked 100 cigarettes in their lifetime if they have health coverage.

```{r prob, echo = FALSE, eval = FALSE}
exp(0.0565)
exp(-0.0004316)
exp(-0.358)
```

We will conclude with this research question by examining the strength of our model. We will do this by constructing a confusion matrix (Table 2.2) with a threshold of 0.6 to determine the classification error rate. Based on the table, our model predicted $0.9 + 46.1 = 47\%$ of the individuals incorrectly, leading to a classification error rate of 47%. While this is slightly better than random, which would be 50%, it is still a high classification error rate and may suggest that our model is not the best for determining the relationship between age and having health coverage and whether or not a person smokes at least 100 cigarettes in their lifetime.

```{r confus-matrix, echo = FALSE, message = FALSE, warning = FALSE, fig.asp = 0.7}
probabilities <- predict(model1, type = "resp")
predicted.Y <- ifelse(probabilities > 0.6, "1", "0")

tbl <- table("Prediction"= predicted.Y, "Actual" = cdc$smoke100)

cfm <- tidy(tbl)
plot_confusion_matrix(cfm, 
                      target_col = "Actual", 
                      prediction_col = "Prediction",
                      counts_col = "n",
                      palette = "Purples",
                      font_counts = font(
                        size = 3, color = "black"),
                      add_normalized = TRUE,
                      add_col_percentages = FALSE,
                      add_row_percentages = FALSE) +
  labs(title = "Table 2.2: Confusion Matrix for Chosen Model", 
       x = "Actual", y = "Predicted")
```


```{r calc 4, echo = FALSE, eval = FALSE}
0.9+46.1
```

## Section 3: EDA: Research Question 2

The second question we would like to explore is the relationship between smoking, exercise, desired weight change, having health coverage, and age, and a person’s overall evaluation of their health. Before diving into this relationship, let us first examine the data and extract any information that may be helpful in constructing a useful model. 

The table below (Table 3.1) shows the counts for how a person evaluates their health, with the total number of individuals being 20,000. The category with the largest number of individuals is the "very good" category, with 6,972 people evaluating their health as very good. The category with the smallest number of individuals is the "poor" category, with 677 evaluating their health as poor. This leaves us with 34.86% of our data in the largest category, and 3.39% of the data in our smallest category. Although we typically want to see at least 10% of the data in our smallest category, because there is a noticeable difference between the different levels, we will proceed with our analysis with the data as it is to see what relationships we can draw out. If the small number of individuals in the "poor" category cause unexpected results, we will handle that later in the analysis.

```{r tableRQ2, echo = FALSE}
knitr::kable(table(cdc$genhlth), col.names=c("Evaluation", "Count"), 
             caption = "Table 3.1: Health Evaluation Counts")
```

```{r calc-tbl, echo = FALSE, eval = FALSE}
4657+6972+5675+2019+677
(6972/20000)*100
(677/20000)*100
```

Now that we have taken a look at how much data is in each of the categories in our response variable, let's move on the exploring the relationship between $Y$ and our predictors. First, let us examine the relationship between how an individual evaluates their health and the individual's age. The box plot below (Figure 3.1) displays the relationship between an individuals age and their evaluation of their health.

After examining the box plot for this relationship, it appears that, generally, as an individual gets older, they evaluate their health closer to the "poor" category and further from the "excellent" category. While the "excellent" category appears to center around age 38, the "poor" category appears to center around age 57.

```{r boxplot, echo = FALSE}
ggplot(data = cdc, aes(x = age, y = genhlth)) +
  geom_boxplot(fill = c("thistle", "thistle1", "thistle2", 
                        "thistle3", "thistle4")) +
  labs(title = "Figure 3.1: Health Evaluation by Age", x = "Age", 
       y = "Health Evaluation") +
  theme_light()
```

```{r function2, echo = FALSE}
get_logRR <- function(xvar , yvar, level, baseline, xname, bins ){
  nbins <- length(bins)
  probs.each <-NULL
  
  for(i in 1:nbins){
    if( i < nbins){
    scores.in <- which(xvar< bins[i+1] & xvar >= bins[i])
  } else{ 
    scores.in <- which(xvar> bins[i])
    }
    numerator  <- length(which(yvar[scores.in]==level))
    denominator      <- length(which(yvar[scores.in]==baseline))
    probs.each <- c(probs.each,ifelse(numerator>0 & denominator>0,
                                      numerator/denominator,0))
  }
  
  log.RR.each <- log(probs.each)
  
  log.RR.each
  
}
```

Diving deeper into this relationship between age and how a person evaluates their health, let us examine the relationship between age and the log relative risk of each of our health evaluation categories, with "very good" as the baseline, due to it being the largest category. The plot blow (Figure 3.2) displays the relationship between age and the log relative risk of each category versus the "very good" category. Although the relationship is somewhat linear, there appears to be a general up-and-down pattern among each of the graphs. The "Excellent vs. Very Good" plot has the most number of changes, with a general increasing pattern from around age 0 to 25, a decreasing pattern from around age 25 to 38, an increasing pattern from around age 38 to 50, a decreasing pattern from around age 50 to 80, and then a somewhat-increasing pattern from 80 onward. The "Fair vs. Very Good" plot has the least number of changes, with a generally increasing pattern the entire time. There may be a slight change from increasing to decreasing from around age 19 to 26, and again from around age 78 onward. Due to these fluctuations, a third-order polynomial may be helpful in modeling this relationship. 

```{r plot5, echo = FALSE, message = FALSE, warning = FALSE}
mybins <- seq(from = 0, to = 100, by = 5)
logRR1 <- get_logRR(xvar = cdc$age, yvar = cdc$genhlth, 
                   level = "excellent", baseline = "very good", xname = "age", 
                   bins = mybins)

plot1 <- ggplot(data.frame(mybins, logRR1), aes(x = mybins, y = logRR1)) + 
  geom_point() +
  labs(x = "Age", y = "Excellent vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ x, size = 1, 
              color = "darkorchid3")

logRR2 <- get_logRR(xvar = cdc$age, yvar = cdc$genhlth, 
                   level = "good", baseline = "very good", xname = "age", 
                   bins = mybins)
plot2 <- ggplot(data.frame(mybins, logRR2), aes(x = mybins, y = logRR2)) + 
  geom_point() +
  labs(x = "Age", y = "Good vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ x, size = 1, 
              color = "darkorchid3")

logRR3 <- get_logRR(xvar = cdc$age, yvar = cdc$genhlth, 
                   level = "fair", baseline = "very good", xname = "age", 
                   bins = mybins)
plot3 <- ggplot(data.frame(mybins, logRR3), aes(x = mybins, y = logRR3)) + 
  geom_point() +
  labs(x = "Age", y = "Fair vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ x, size = 1, 
              color = "darkorchid3")

logRR4 <- get_logRR(xvar = cdc$age, yvar = cdc$genhlth, 
                   level = "poor", baseline = "very good", xname = "age", 
                   bins = mybins)
plot4 <- ggplot(data.frame(mybins, logRR4), aes(x = mybins, y = logRR4)) + 
  geom_point() +
  labs(x = "Age", y = "Poor vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ x, size = 1, 
              color = "darkorchid3")

p <- plot_grid(plot1, plot2, plot3, plot4)

title <- ggdraw() + 
draw_label("Figure 3.2: Age vs. Log Relative Risk with Baseline Level Very Good", 
           fontface='bold', 
             size = 11, x = .5, y = .5)

plot_grid(title, p, ncol = 1, nrow = 2, rel_heights = c(.1, 1), 
          rel_widths = c(.2, 1))
```

To test our theory that a third-order polynomial may be more appropriate for modeling the relationship between age and how somewhere evaluates their health, let us examine the plot below (Figure 3.3). Although the fit to the "Poor vs. Very Good" graph appears relatively stretched and linear, the rest of the plots seem to follow the third-order polynomial quite well. Thus, we will proceed with our age predictors as a third-order polynomial.

```{r plot6, echo = FALSE, message = FALSE, warning = FALSE}
mybins <- seq(from = 0, to = 100, by = 5)

plot5 <- ggplot(data.frame(mybins, logRR1), aes(x = mybins, y = logRR1)) + 
  geom_point() +
  labs(x = "Age", y = "Excellent vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ poly(x,3), size = 1, 
              color = "darkorchid3")

plot6 <- ggplot(data.frame(mybins, logRR2), aes(x = mybins, y = logRR2)) + 
  geom_point() +
  labs(x = "Age", y = "Good vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ poly(x,3), size = 1, 
              color = "darkorchid3")

plot7 <- ggplot(data.frame(mybins, logRR3), aes(x = mybins, y = logRR3)) + 
  geom_point() +
  labs(x = "Age", y = "Fair vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ poly(x,3), size = 1, 
              color = "darkorchid3")

plot8 <- ggplot(data.frame(mybins, logRR4), aes(x = mybins, y = logRR4)) + 
  geom_point() +
  labs(x = "Age", y = "Poor vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ poly(x,3), size = 1, 
              color = "darkorchid3")

plot_grid <- plot_grid(plot5, plot6, plot7, plot8)

title <- ggdraw() + 
draw_label("Figure 3.3: Age vs. Log Relative Risk with Baseline Level Very Good 
           with Third-Order Polynomial", fontface='bold', 
             size = 11, x = .5, y = .5)

plot_grid(title, plot_grid, ncol = 1, nrow = 2, rel_heights = c(.1, 1), 
          rel_widths = c(.2, 1))
```

Now that we have examined the relationship between age and how a person evaluates their health, let us now on to our categorical predictors: whether or not a person smokes 100 cigarettes in their lifetime, whether or not a person has exercised in the last month, and whether or not a person has a health plan. To do this, let us examine bar graphs which count how individuals evaluate their health in each category. 

The plot below (Figure 3.4) shows the relationship between each of our categorical predictors and how a person evaluates their health. For whether or not a person smoked 100 cigarettes in their lifetime and whether or not a person has exercised in the last month, the relationship is strikingly clear. For a person who has smoked, and a person who had not exercised, they rated their health closer to "poor", while for a person who has not smoked, and a person who has exercised, they rater their health closed to "excellent". For whether or not a person has a health plan, the relationship is not as clear. However, generally, it appears that those who a health plan are most likely to rate their health as "excellent" or "very good", while those without a health plan are most likely to rate their health as "fair".

```{r bar-graphs, echo = FALSE}
p1 <- ggplot(data = cdc, aes(x = factor(smoke100),  group = factor(genhlth))) + 
    geom_bar(aes(y = ..prop.., fill = factor(genhlth)), stat = "count",
             position = position_dodge()) +
  scale_x_discrete(labels = c("No", "Yes")) +
  scale_fill_manual(name = "Health Evaluation",
                    labels = c("Excellent", "Very good", "Good", "Fair", "Poor"),
                    values = c("thistle2", "plum1", "plum2", "plum3", "plum4")) +
labs(x = "Smoked 100", y = "Proportion") +
  theme_light()

p2 <- ggplot(data = cdc, aes(x = factor(exerany),  group = factor(genhlth))) + 
    geom_bar(aes(y = ..prop.., fill = factor(genhlth)), stat = "count",
             position = position_dodge()) +
  scale_x_discrete(labels = c("No", "Yes")) +
  scale_fill_manual(name = "Health Evaluation",
                      labels = c("Excellent", "Very good", "Good", "Fair", "Poor"),
                      values = c("thistle2", "plum1", "plum2", "plum3", "plum4")) +
labs(x = "Exercised", y = "Proportion") +
  theme_light()

p3 <- ggplot(data = cdc, aes(x = factor(hlthplan),  group = factor(genhlth))) + 
    geom_bar(aes(y = ..prop.., fill = factor(genhlth)), stat = "count",
             position = position_dodge()) +
  scale_x_discrete(labels = c("No", "Yes")) +
  scale_fill_manual(name = "Health Evaluation",
                    labels = c("Excellent", "Very good", "Good", "Fair", "Poor"),
                    values = c("thistle2", "plum1", "plum2", "plum3", "plum4")) +
labs(x = "Health Plan", y = "Proportion") +
  theme_light()

grid_plot <- plot_grid(p1, p2, p3)

title <- ggdraw() + 
draw_label("Figure 3.4: Categorical Predictors vs. Health Evaluation", fontface='bold', 
             size = 11, x = .5, y = .5)

plot_grid(title, grid_plot, ncol = 1, nrow = 2, rel_heights = c(.1, 1), 
          rel_widths = c(.2, 1))
```

The final relationship we need to explore before building our model is the relationship between how a person evaluates their health and their desired weight change. We will examine this relationship similarly to the way in which we examined the relationship between age and how a person evaluates their health. First, let us examine a box plot. 

In the box plot below (Figure 3.5), let us first note that only those who had a desire weight change of between -150 and 150 were considered due to a large number of outliers. Thus, we are more interested in the small changes near the center of the graph than the fluctuations in the outliers. In the plot, it appears that those who rated their health as "excellent" had less variance in how much they wanted their weight to change, with the results centering just above 0. However, it appears that those who rated their health as "poor" had a higher variance in how much they wanted their weight to change, with the results centering slightly further above 0, but spreading much wider. Thus, it may be that those who are confident in their health do not have much desire to change their weight, while those who are not confident in their health do have a desire to change their weight. 

```{r boxplot2, echo = FALSE}
cdc %>%
filter(wtdesire > -150) %>%
  filter(wtdesire < 150) %>%
ggplot(aes(x = wtdesire, y = genhlth)) +
  geom_boxplot(fill = c("thistle", "thistle1", "thistle2", 
                        "thistle3", "thistle4")) +
  labs(title = "Figure 3.5: Health Evaluation by Desired Weight Change", x = "Desired Weight Change", 
       y = "Health Evaluation") +
  theme_light()
```

Diving deeper into this relationship between desired weight change and how a person evaluates their health, let us examine the relationship between desired weight change and the log relative risk of each of our health evaluation categories, with "very good" as the baseline, due to it being the largest category. The plot blow (Figure 3.6) displays the relationship between desired weight change and the log relative risk of each category versus the "very good" category. Similarly to the box plots above, we are only examining weight changes between -150 and 150 due to the very distant outliers which may the graphs difficult to interpret. 

Although the relationship is somewhat linear, there appears to be a general up-and-down pattern among each of the graphs, similar to what we saw with age. In the "excellent vs. very good" graph there are the most changes in direction, with the log relative risk of excellent vs. very good increasing from around a weight change of -100 to 0, decreasing from around 0 to 100, and increasing from around 100 onward. In the "poor vs. very good" graph, there are the least changes in direction, with the log relative risk of poor vs. very good decreasing from around -100 to 0 and increasing onward. With this in mind, let us consider a second-order polynomial for modeling the relationship between desired weight change and how a person evaluates their health. 


```{r comparing-plots, echo = FALSE, warning = FALSE, message = FALSE}
mybins <- seq(from = -150, to = 150, by = 10)

logRR5 <- get_logRR(xvar = cdc$wtdesire, yvar = cdc$genhlth, 
                   level = "excellent", baseline = "very good", xname = "age", 
                   bins = mybins)

p4 <- ggplot(data.frame(mybins, logRR5), aes(x = mybins, y = logRR5)) + 
  geom_point() +
  labs(x = "Weight Change", y = "Excellent vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ x, size = 1, 
              color = "darkorchid3")

logRR6 <- get_logRR(xvar = cdc$wtdesire, yvar = cdc$genhlth, 
                   level = "good", baseline = "very good", xname = "age", 
                   bins = mybins)
p5 <- ggplot(data.frame(mybins, logRR6), aes(x = mybins, y = logRR6)) + 
  geom_point() +
  labs(x = "Weight Change", y = "Good vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ x, size = 1, 
              color = "darkorchid3")

logRR7 <- get_logRR(xvar = cdc$wtdesire, yvar = cdc$genhlth, 
                   level = "fair", baseline = "very good", xname = "age", 
                   bins = mybins)
p6 <- ggplot(data.frame(mybins, logRR7), aes(x = mybins, y = logRR7)) + 
  geom_point() +
  labs(x = "Weight Change", y = "Fair vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ x, size = 1, 
              color = "darkorchid3")

logRR8 <- get_logRR(xvar = cdc$wtdesire, yvar = cdc$genhlth, 
                   level = "poor", baseline = "very good", xname = "age", 
                   bins = mybins)
p7 <- ggplot(data.frame(mybins, logRR8), aes(x = mybins, y = logRR8)) + 
  geom_point() +
  labs(x = "Weight Change", y = "Poor vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ x, size = 1, 
              color = "darkorchid3")

plotted <- plot_grid(p4, p5, p6, p7)

title <- ggdraw() + 
draw_label("Figure 3.6: Desired Weight Change vs. Log Relative Risk with 
           Baseline Level Very Good", 
           fontface='bold', 
             size = 11, x = .5, y = .5)

plot_grid(title, plotted, ncol = 1, nrow = 2, rel_heights = c(.1, 1), 
          rel_widths = c(.2, 1))
```

To test our theory that a second-order polynomial may be more appropriate for modeling the relationship between desired weight change and how somewhere evaluates their health, let us examine the plot below (Figure 3.7). Although the fit to the "Poor vs. Very Good" graph appears to follow a second-order polynomial quite well, the rest of the graphs still appear to be relatively linear. Therefore, we are going to discard the second-order polynomial in favor of a basic linear relationship between desired weight change and how somewhere evaluates their health.

```{r plot-secorder, echo = FALSE, warning = FALSE, message = FALSE}
p10 <- ggplot(data.frame(mybins, logRR5), aes(x = mybins, y = logRR5)) + 
  geom_point() +
  labs(x = "Weight Change", y = "Excellent vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ poly(x,2), size = 1, 
              color = "darkorchid3")

p11 <- ggplot(data.frame(mybins, logRR6), aes(x = mybins, y = logRR6)) + 
  geom_point() +
  labs(x = "Weight Change", y = "Good vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ poly(x,2), size = 1, 
              color = "darkorchid3")

p12 <- ggplot(data.frame(mybins, logRR7), aes(x = mybins, y = logRR7)) + 
  geom_point() +
  labs(x = "Weight Change", y = "Fair vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ poly(x,2), size = 1, 
              color = "darkorchid3")

p13 <- ggplot(data.frame(mybins, logRR8), aes(x = mybins, y = logRR8)) + 
  geom_point() +
  labs(x = "Weight Change", y = "Poor vs. Very Good") +
  theme_light() +
  stat_smooth(method = "lm", formula = y ~ poly(x,2), size = 1, 
              color = "darkorchid3")

plotted1 <- plot_grid(p10, p11, p12, p13)

title <- ggdraw() + 
draw_label("Figure 3.7: Desired Weight Change vs. Log Relative Risk with 
           Baseline Level Very Good with Second Order Polynomial", 
           fontface='bold', 
             size = 11, x = .5, y = .5)

plot_grid(title, plotted1, ncol = 1, nrow = 2, rel_heights = c(.1, 1), 
          rel_widths = c(.2, 1))
```

## Section 4: Modeling: Research Question 2

Now that we have explored the relationship between our response variable and our explanatory variables, as well as confirmed that there is ample data to work with, we can begin to model this relationship. Since we have a multi-level response variable, how an individual evaluates their health, where $P(Y_i = Poor) = \pi_{i(Poor)}$, $P(Y_i = Fair) = \pi_{i(Fair)}$, $P(Y_i = Good) = \pi_{i(Good)}$, $P(Y_i = VeryGood) = \pi_{i(VeryGood)}$, and $P(Y_i = Excellent) = \pi_{i(Excellent)}$, and $\pi_{i(Poor)} + \pi_{i(Fair)} + \pi_{i(Good)} + \pi_{i(VeryGood)} + \pi_{i(Excellent)} = 1$, we can reasonable assume a categorical distribution, $Y_i \sim Categorical(\pi_{i(Poor)}, \pi_{i(Fair)}, \pi_{i(Good)}, \pi_{i(VeryGood)}, \pi_{i(Excellent)})$.

Because we have a categorical distribution, we will select a multinomial regression model for modeling our relationship. Recalling our third-order polynomial transformation for age, and "very good" as our baseline, the model will be written as:

$$log \left(\frac{\pi_{i(Poor)}}{\pi_{i(VeryGood)}}  \right) = \beta_{0(Poor)}+\beta_{1(Poor)}Age_i+\beta_{2(Poor)}Age_i^2+\beta_{3(Poor)}Age_i^3+\beta_{4(Poor)}Smoke_i+\beta_{5(Poor)}Exercise_i$$
$$+\beta_{6(Poor)}WeightChange_i+\beta_{7(Poor)}HealthPlan_i$$

$$log \left(\frac{\pi_{i(Fair)}}{\pi_{i(VeryGood)}}  \right) = \beta_{0(Fair)}+\beta_{1(Fair)}Age_i+\beta_{2(Fair)}Age_i^2+\beta_{3(Fair)}Age_i^3+\beta_{4(Fair)}Smoke_i+\beta_{5(Fair)}Exercise_i$$
$$+\beta_{6(Fair)}WeightChange_i+\beta_{7(Fair)}HealthPlan_i$$

$$log \left(\frac{\pi_{i(Good)}}{\pi_{i(VeryGood)}}  \right) = \beta_{0(Good)}+\beta_{1(Good)}Age_i+\beta_{2(Good)}Age_i^2+\beta_{3(Good)}Age_i^3+\beta_{4(Good)}Smoke_i+\beta_{5(Good)}Exercise_i$$
$$+\beta_{6(Good)}WeightChange_i+\beta_{7(Good)}HealthPlan_i$$

$$log \left(\frac{\pi_{i(Excellent)}}{\pi_{i(VeryGood)}}  \right) = \beta_{0(Excellent)}+\beta_{1(Excellent)}Age_i+\beta_{2(Excellent)}Age_i^2+\beta_{3(Excellent)}Age_i^3+\beta_{4(Excellent)}Smoke_i$$
$$+\beta_{5(Excellent)}Exercise_i+\beta_{6(Excellent)}WeightChange_i+\beta_{7(Excellent)}HealthPlan_i$$


```{r fit-model-multinom, echo = FALSE, include = FALSE}
cdc$genhlth <- relevel(cdc$genhlth, ref = "very good")
model_multinom <- multinom(genhlth ~ age + I(age^2) + I(age^3) + smoke100 + exerany + wtdesire + hlthplan, data = cdc)
coef(model_multinom)
```

After fitting our model of interest, we can write down the completed model to be used for estimating the parameters of interest:

$$log \left(\frac{\hat{\pi}_{i(Poor)}}{\hat{\pi}_{i(VeryGood)}}  \right) = -3.094691-0.017391Age_i+0.001676Age_i^2-0.000012Age_i^3+0.717089Smoke_i-1.523724Exercise_i$$
$$+0.014570WeightChange_i-0.953660HealthPlan_i$$

$$log \left(\frac{\hat{\pi}_{i(Fair)}}{\hat{\pi}_{i(VeryGood)}}  \right) = 1.607572-0.167891Age_i+0.003712Age_i^2-0.000021Age_i^3+0.276716Smoke_i-0.976568Exercise_i$$
$$+0.012519WeightChange_i-1.040213HealthPlan_i$$

$$log \left(\frac{\hat{\pi}_{i(Good)}}{\hat{\pi}_{i(VeryGood)}}  \right) = 1.361574-0.079250Age_i+0.001689Age_i^2-0.000009Age_i^3+0.156458Smoke_i-0.536337Exercise_i$$
$$+0.006524WeightChange_i-0.5208946HealthPlan_i$$

$$log \left(\frac{\hat{\pi}_{i(Excellent)}}{\hat{\pi}_{i(VeryGood)}}  \right) = -1.435571+0.067057Age_i-0.001060Age_i^2+0.000004Age_i^3-0.331278Smoke_i$$
$$+0.167257Exercise_i-0.013343WeightChange_i+0.090839HealthPlan_i$$


Now that we have created our model and fitted our regression lines, let us examine the usefulness of our predictors, where we are specifically interested in whether or not our exercise variable is helpful to the model. To do this, we want to create a separate model that does not contain exercise, and compare that model to our current, larger model. We will make these comparisons using a nested likelihood ratio test, where our null hypothesis is that the larger model is not a better fit to the data than the smaller model, and our alternative hypothesis is that the larger model is a better fit to the data than the smaller model. 

In order to use the nested likelihood ratio test, we first must determine $G = D_{smaller} - D_{larger}$. We know that the deviance for our smaller model is 53,898.22 and the deviance for our larger model is 53,208.76. Thus, 

$$G = 53898.22 - 53208.76 = 689.46$$
where, if the null hypothesis were true and the larger model were not a better fit to the data than the smaller model, $G \sim X^2(df=1)$.

Now, using this information to determine our p-value, we get:

$$p-value = P(G \geq 689.46|H_0\ were\ true) \approx 0.0 $$

Thus, with a p-value of virtually 0, the probability of seeing a test statistic as extreme or more extreme than 689.46, given that the null hypothesis is true, is 0. Thus, we do have convincing evidence that the larger model, which contains exercise as a predictor, is a better fit than the smaller model, which does not contain exercise as a predictor. 

```{r nested-lrt, echo = FALSE, include = FALSE}
model_multinom_small <- multinom(genhlth ~ age + I(age^2) + I(age^3) + smoke100 + wtdesire + hlthplan, data = cdc)
deviance(model_multinom_small)
deviance(model_multinom)
53898.22 - 53208.76
```

```{r test, echo = FALSE, include = FALSE}
pchisq(689.46, df = 1, lower.tail = FALSE)
```

```{r final-sum, echo = FALSE, include = FALSE}
modelNull <- multinom(genhlth~1, data = cdc)
deviance(modelNull)
deviance(model_multinom)
AIC(modelNull)
AIC(model_multinom)
```

Now, let us briefly examine the usefulness of our model by stating the AIC and the drop in deviance from the null model. The null model has a deviance of 56,409.68 and our model has a deviance of 53,208.76. Thus, to find the drop in deviance, we will write:

$$\%dropDev = \frac{56,409.68 - 53,208.76}{56,409.68} = \frac{3,200.92}{56,409.68} \times 100 = 5.674\%$$

```{r calculate, echo = FALSE, eval = FALSE}
56409.68-53208.76
(3200.92/56409.68)*100
```

Therefore, our model has a 5.674% drop in deviance from the null model. Also while our model has an AIC of 53,272.76, the null model has an AIC of 56,417.68, which is larger than the AIC for our model. Thus, we can say that our model is better at predicting how a person evaluates their health than if only the intercept were used. 

## Section 5: Conclusions: Research Question 2

Now, let us assume we have an individual who does not smoke, does exercise, has a health plan, and desires to lose 20 pounds. For people meeting these criteria, we want to understand the relationship between the predicted probabilities and age. The plot below (Figure 5.1) displays the predicted probabilities of health evaluation by age for an individual who does not smoke, does exercise, has a health plan, and desires to lose 20 pounds. 

```{r multinom-function, echo = FALSE, include = FALSE, warning = FALSE, message = FALSE}
plot_probsMultinom2 <- function(xvar , model, xname ){
  xpart <- data.frame(c(unique(xvar)))
  xpart <- cbind(xpart, "exerany" = 1, "hlthplan" = 1, "smoke100" = 0, "wtdesire"= 20) 
  names(xpart)[1] <- xname
  pp.xpart <- cbind(xpart, predict(model, newdata = xpart, type = "probs", se = TRUE))
  
  lpp <- melt(pp.xpart, id.vars = c(xname), value.name = "probability")
  n <- nrow(lpp)
  lpp <- lpp[325:n,]
  
  ggplot(lpp, aes(x = lpp[,1], y = probability)) + geom_line(color = "darkorchid3") +
    facet_grid(variable~., scales = "free") +
    theme(axis.text = element_text(size = 10), axis.title = element_text(size=14), legend.title = element_text(size = 14), legend.text = element_text(size = 14)) + 
    ylim(0,0.60) +
    labs(x = xname, y = "Predicted Probabilitiy")
}
```

```{r plot-probs, echo = FALSE}
plot_probsMultinom2(xvar = cdc$age, model = model_multinom, xname = "age") +
  labs(title = "Figure 5.1: Predicted Probabilities: Age vs. Health Evaluation",
       x = "Age", y = "Predicted Probability") +
  theme_light()
```

Examining the plot above (Figure 5.1), we can see that, generally, for those who do not smoke, do exercise, have a health plan, and desire to lose 20 pounds, they are most likely to evaluate their health as very good from age 19 to age 75 and evaluate their health as good from age 75 onward. They are least likely to evaluate their health as poor across all ages. Further, we can also see that, generally, the probability of an individual who does not smoke, does exercise, does have a health plan, and desires to lose 20 pounds to evaluate their health as very good decreases slightly as they grow older, and after age 50, their likelihood to evaluate their health as good or fair increases slightly as they grow older. They are also most likely to evaluate their health as excellent around age 37, and least likely from ages 75 onward. 

Overall, it appears that individuals who do not smoke, do exercise, have a health plan, and desire to lose 20 pounds generally evaluate themselves as relatively healthy across all ages, with that evaluation only slightly decreasing as they reach 50 and above. This result can be expected, due to not smoking, exercising, having a health plan, and only being slightly above your desired weight being associated with being healthy. Thus, we may also be able to assume that a person who does smoke, does not exercise, does not have a health plan, and desires to lose or gain more than 20 pounds would generally evaluate their health as less than what we see above across all ages.
